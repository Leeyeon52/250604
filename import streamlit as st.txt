import streamlit as st
from streamlit_chat import message
import pandas as pd
from sentence_transformers import SentenceTransformer
import numpy as np
from pathlib import Path

# ëª¨ë¸ ë¡œë”©
@st.cache_resource
def load_model():
    return SentenceTransformer('jhgan/ko-sroberta-multitask')

# ë°ì´í„°ì…‹ ë¡œë”©
@st.cache_data
def load_dataset():
    dataset_path = Path(r'D:\í•™ìŠµ\250528\wellness_dataset.csv')
    if not dataset_path.exists():
        st.error(f"âŒ ë°ì´í„°ì…‹ ê²½ë¡œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: {dataset_path}")
        st.stop()
    df = pd.read_csv(dataset_path)
    df = df[['ì‚¬ëŒë¬¸ì¥1', 'ì‹œìŠ¤í…œë¬¸ì¥1']].dropna().reset_index(drop=True)
    return df

# ë¬¸ì¥ ì„ë² ë”© ìƒì„±
@st.cache_data
def embed_corpus(sentences, model):
    return np.array([model.encode(sentence) for sentence in sentences])

# ê°€ì¥ ìœ ì‚¬í•œ ì‘ë‹µ ì°¾ê¸°
def find_best_answer(user_input, model, corpus_sentences, corpus_embeddings):
    user_embedding = model.encode(user_input)
    similarities = np.dot(corpus_embeddings, user_embedding) / (
        np.linalg.norm(corpus_embeddings, axis=1) * np.linalg.norm(user_embedding)
    )
    best_idx = int(np.argmax(similarities))
    return corpus_sentences[best_idx], best_idx

# ëª¨ë¸ ë° ë°ì´í„° ì¤€ë¹„
model = load_model()
df = load_dataset()
corpus_sentences = df['ì‚¬ëŒë¬¸ì¥1'].tolist()
corpus_embeddings = embed_corpus(corpus_sentences, model)

# Streamlit UI ì„¤ì •
st.set_page_config(page_title="ì‹¬ë¦¬ìƒë‹´ ì±—ë´‡", page_icon="ğŸ§ ")
st.title("ğŸ§  ì‹¬ë¦¬ìƒë‹´ ì±—ë´‡")
st.markdown("ì´ê³³ì— ë‹¹ì‹ ì˜ ê³ ë¯¼ì„ ì´ì•¼ê¸°í•´ ë³´ì„¸ìš”.")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'generated' not in st.session_state:
    st.session_state['generated'] = []
if 'past' not in st.session_state:
    st.session_state['past'] = []

# ì…ë ¥ í¼
with st.form('chat_form', clear_on_submit=True):
    user_input = st.text_input("ğŸ’¬ ë‹¹ì‹ :", "")
    submitted = st.form_submit_button("ì „ì†¡")

# ì‘ë‹µ ì²˜ë¦¬
if submitted and user_input:
    _, best_idx = find_best_answer(user_input, model, corpus_sentences, corpus_embeddings)
    response = df.loc[best_idx, 'ì‹œìŠ¤í…œë¬¸ì¥1']

    st.session_state.past.append(user_input)
    st.session_state.generated.append(response)

# ëŒ€í™” ë‚´ìš© ì¶œë ¥
for i in range(len(st.session_state.past)):
    message(st.session_state.past[i], is_user=True, key=f"user_{i}")
    message(st.session_state.generated[i], key=f"bot_{i}")
